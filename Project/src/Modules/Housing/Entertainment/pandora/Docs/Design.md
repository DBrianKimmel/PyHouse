* Name:      PyHouse/Project/src/Modules/Housing/Entertainment/pandora/Docs/Design.md
* Author:    D. Brian Kimmel
* Contact:   D.BrianKimmel@gmail.com
* Copyright: (c) 2018-2019 by D. Brian Kimmel
* Created:   2018-09-30
* Updated:   2019-06-02
* License:   MIT License
* Summary:   This is the design documentation for the Pandora Module of PyHouse.


# Pandora

Pandora is a PyHouse Entertainment system Plugin.
Therefore, it only loads when configured in the xml on any particular node.
It should only be configured if PianoBar is installed on the node.

The pandora module has several functions.

* Mqtt listener and sender.
* Interfaces to PianoBar
* Controls the A/V System to play pandora music throught the house and grounds.

Pandora and Pianobar run on a Rasapberry Pi computer (node) and there may be more than one such nodes.
Each node requires a stream license from Pandora.

This describes the setup for playing pandora through your entertainment system.

Pandora is started by one or more nodes receiving a pandora control Mqtt message.
That message needs to contain a 'Power: On' section.

A raspberry PI is used.
It has the pianobar on the computer node.

Run pianobar once manually to get the current config info for your account.
Fill in the appropriate information in the config file an place it in the proper place on the pandora computer.

## Design

The pandora module will use pianobar to receive a stream from the pandora servers.
The computer running this may be connected to one or more A/V devices to play the music somewhere in the house.

This module receives a Mqtt control message to allow people to control the music.
Therefore it is responsible for issuing Mqtt control messages to various A/V PyHouse modules to control the sound.

This module also receives the play information from pianobar and sends a Mqtt message to allow the person to
know what is going on.

house/entertainment/pandora/status

Pandora sometimes needs a new key.
This is generated by ????


### Control Message

The pandora module will recieve a control message and perform the action:
The computer where 'PianoBar' is installed should be the one where the pandora service is configured.
These messages have topics:
		pyhouse/house name/house/entertainment/pandora/control
where xxx is one of:
* PowerOn
* PowerOff
* VolumeUp1
* VolumeUp5
* VolumeDown1
* VolumeDown5
* LikeYes
* LikeNo
* SkipYes

.../control msg=on will have side effects of turning on and setting the "ConnectionModel" device.

### Status Message

This module issues status messages to inform the rest of PyHouse what is happening with pandora.
These messages have topics:

		pyhouse/house name/house/entertainment/pandora/status

The message will contain:
* Sender - The name of the Node sending the status.
* Last Update
* Name - The name of the service sending the status.

## XML / Configuration

** The pandora service should only be configured on computers where PianoBar is installed. **

```xml
<PandoraSection Active="True">
	<Type>Service</Type>
	<MaxSessions>1</MaxSessions>
	<Service Active="True" Key="0" Name="Pianobar running on pi-07-pp">
		<Comment>Living Room</Comment>
		<Host>pandora-pp</Host>
		<MaxPlayTime>12345</MaxPlayTime>
		<Type>Service</Type>
		<ConnectionFamily>pioneer</ConnectionFamily>
		<ConnectionModel>822-k</ConnectionModel>
		<Output>Headphone</Output>
		<InputName>CD</InputName>
		<Volume>47</Volume>
		<Zone>1</Zone>
	</Service>
</PandoraSection>

```

* Host is the name or IP address of the computer running PyHouse and PianoBar.
* Max Sessions is the number of sessions you are allowed by your service agreement.
* Type is always Service.
* ConnectionFamily must match one of the Entertainment modules that are programmed and must be lower case.
* ConnectionModel must match one of the devices in the family and also must be lower case.
* InputName is the name of the connection on the family device where the cable from the pandora computer is plugged in.
* Volume is a percent of full volume to be selected when first connecting.

The following line must be placed in /etc/hosts with that is the IP address of the pandora computer.

```
192.168.1.17	pandora
```

## Now Playing

format of now-playing song = "%t" by "%a" on "%l"%r%@%s
Now playing song message format. Available format characters are:
* %t Song title
* %a Song artist
* %l Album name
* %r Rating icon (only love icon)
* %@ at_icon if station is quickmix, empty otherwise.
* %s Real station name if quickmix
* %u Song detail url

## Audio on Raspberry Pi

### Alsa

If you see this:
`ALSA lib pcm.c:2495:(snd_pcm_open_noupdate) Unknown PCM cards.pcm.front`

Edit the file: `/usr/share/alsa/alsa.conf`
change the line “pcm.front cards.pcm.front” to “pcm.front cards.pcm.default”

### END DBK
